# by Richi Rod AKA @richionline / falken20

from datetime import date

from .basetest import BaseTestCase
from falken_drinks.models import db, User, Drink, DrinkLog
from falken_drinks.controllers import ControllerUser, ControllerDrinks, ControllerDrinkLogs


class TestControllerUser(BaseTestCase):

    def test_create_user(self):
        user = self.create_user()
        self.assertTrue(user.user_id)
        self.assertEqual(user.email, self.mock_user['email'])
        self.assertEqual(user.name, self.mock_user['name'])
        self.assertTrue(user.password)
        self.assertTrue(user.date_created)

    def test_delete_user(self):
        user = self.create_user()
        self.assertTrue(user.user_id)
        ControllerUser.delete_user(user.user_id)
        self.assertFalse(User.query.filter_by(id=user.user_id).first())

    def test_get_user(self):
        user = self.create_user()
        user_get = ControllerUser.get_user(user.user_id)
        self.assertEqual(user_get.email, user.email)

    def test_get_user_email(self):
        user = self.create_user()
        user_get = ControllerUser.get_user_email(user.email)
        self.assertEqual(user_get.email, user.email)

    def test_get_user_name(self):
        user = self.create_user()
        user_get = ControllerUser.get_user_name(user.name)
        self.assertEqual(user_get.name, user.name)

    def test_get_user_no_user(self):
        user = ControllerUser.get_user(1)
        self.assertFalse(user)


class TestControllerDrinks(BaseTestCase):

    def test_get_drink(self):
        """Test getting a drink by ID"""
        drink = Drink(drink_name='Test Water', drink_water_percentage=100, drink_alcohol_percentage=0)
        db.session.add(drink)
        db.session.commit()
        
        drink_get = ControllerDrinks.get_drink(drink.drink_id)
        self.assertEqual(drink_get.drink_name, 'Test Water')

    def test_get_drink_name(self):
        """Test getting a drink by name"""
        drink = Drink(drink_name='Test Water', drink_water_percentage=100, drink_alcohol_percentage=0)
        db.session.add(drink)
        db.session.commit()
        
        drink_get = ControllerDrinks.get_drink_name('Test Water')
        self.assertEqual(drink_get.drink_name, 'Test Water')

    def test_add_drink(self):
        """Test adding a new drink"""
        drink_data = {
            'drink_name': 'Test Beer',
            'drink_water_percentage': 95,
            'drink_alcohol_percentage': 5
        }
        drink = ControllerDrinks.add_drink(drink_data)
        
        self.assertIsNotNone(drink)
        self.assertEqual(drink.drink_name, 'Test Beer')
        self.assertEqual(drink.drink_water_percentage, 95)

    def test_get_or_create_drink_existing(self):
        """Test get_or_create with existing drink"""
        drink = Drink(drink_name='Test Water', drink_water_percentage=100, drink_alcohol_percentage=0)
        db.session.add(drink)
        db.session.commit()
        
        result = ControllerDrinks.get_or_create_drink('Test Water', 0, 250)
        self.assertEqual(result.drink_id, drink.drink_id)

    def test_get_or_create_drink_new(self):
        """Test get_or_create with new drink"""
        result = ControllerDrinks.get_or_create_drink('New Drink', 5, 250)
        self.assertIsNotNone(result)
        self.assertEqual(result.drink_name, 'New Drink')

    def test_delete_drink(self):
        """Test deleting a drink"""
        drink = Drink(drink_name='Test Water', drink_water_percentage=100, drink_alcohol_percentage=0)
        db.session.add(drink)
        db.session.commit()
        
        drink_id = drink.drink_id
        ControllerDrinks.delete_drink(drink_id)
        self.assertFalse(Drink.query.filter_by(drink_id=drink_id).first())

    def test_get_drink_not_found(self):
        """Test getting non-existent drink"""
        drink = ControllerDrinks.get_drink(999)
        self.assertIsNone(drink)

    def test_get_drinks(self):
        """Test getting all drinks"""
        drink1 = Drink(drink_name='Water', drink_water_percentage=100, drink_alcohol_percentage=0)
        drink2 = Drink(drink_name='Beer', drink_water_percentage=95, drink_alcohol_percentage=5)
        db.session.add_all([drink1, drink2])
        db.session.commit()
        
        drinks = ControllerDrinks.get_drinks()
        self.assertGreaterEqual(len(drinks), 2)


class TestControllerDrinkLogs(BaseTestCase):

    def test_add_drink_log(self):
        """Test adding a drink log"""
        user = self.create_user()
        drink = Drink(drink_name='Test Water', drink_water_percentage=100, drink_alcohol_percentage=0)
        db.session.add(drink)
        db.session.commit()
        
        log_data = {
            'drink_id': drink.drink_id,
            'user_id': user.user_id,
            'drink_total_quantity': 250,
            'drink_water_quantity': 250,
            'drink_alcohol_quantity': 0
        }
        
        log = ControllerDrinkLogs.add_drink_log(log_data)
        self.assertIsNotNone(log)
        self.assertEqual(log.drink_total_quantity, 250)

    def test_get_drink_logs_by_user(self):
        """Test getting drink logs for a user"""
        user = self.create_user()
        drink = Drink(drink_name='Test Water', drink_water_percentage=100, drink_alcohol_percentage=0)
        db.session.add(drink)
        db.session.commit()
        
        log = DrinkLog(drink_id=drink.drink_id, user_id=user.user_id,
                      drink_total_quantity=250, drink_water_quantity=250,
                      drink_alcohol_quantity=0)
        db.session.add(log)
        db.session.commit()
        
        consumption = ControllerDrinkLogs.get_daily_consumption(user.user_id, date.today())
        self.assertIsNotNone(consumption)
        self.assertIn('total_liquid', consumption)

    def test_get_daily_summary(self):
        """Test getting daily summary"""
        user = self.create_user()
        drink = Drink(drink_name='Test Water', drink_water_percentage=100, drink_alcohol_percentage=0, counts_as_water=True)
        db.session.add(drink)
        db.session.commit()
        
        log = DrinkLog(drink_id=drink.drink_id, user_id=user.user_id,
                      drink_total_quantity=250, drink_water_quantity=250,
                      drink_alcohol_quantity=0)
        db.session.add(log)
        db.session.commit()
        
        summary = ControllerDrinkLogs.get_daily_summary(user.user_id, date.today())
        self.assertIsNotNone(summary)
        self.assertIn('total_logs', summary)
        self.assertGreater(summary['total_logs'], 0)

    def test_delete_drink_log_by_user(self):
        """Test deleting a drink log by user"""
        user = self.create_user()
        drink = Drink(drink_name='Test Water', drink_water_percentage=100, drink_alcohol_percentage=0)
        db.session.add(drink)
        db.session.commit()
        
        log = DrinkLog(drink_id=drink.drink_id, user_id=user.user_id,
                      drink_total_quantity=250, drink_water_quantity=250,
                      drink_alcohol_quantity=0)
        db.session.add(log)
        db.session.commit()
        
        log_id = log.log_id
        result = ControllerDrinkLogs.delete_drink_log_by_user(log_id, user.user_id)
        self.assertTrue(result)
        self.assertFalse(DrinkLog.query.filter_by(log_id=log_id).first())

    def test_delete_drink_log_unauthorized(self):
        """Test deleting drink log with wrong user"""
        user1 = self.create_user()
        user2_data = {'email': 'user2@mail.com', 'name': 'user2', 'password': 'password'}
        user2 = self.create_user(user2_data)
        
        drink = Drink(drink_name='Test Water', drink_water_percentage=100, drink_alcohol_percentage=0)
        db.session.add(drink)
        db.session.commit()
        
        log = DrinkLog(drink_id=drink.drink_id, user_id=user1.id,
                      drink_total_quantity=250, drink_water_quantity=250,
                      drink_alcohol_quantity=0)
        db.session.add(log)
        db.session.commit()
        
        # Try to delete with wrong user
        result = ControllerDrinkLogs.delete_drink_log_by_user(log.log_id, user2.id)
        self.assertFalse(result)

    def test_get_daily_consumption_with_multiple_drinks(self):
        """Test daily consumption calculation with multiple drinks"""
        user = self.create_user()
        
        # Create different drink types
        water = Drink(drink_name='Water', drink_water_percentage=100, drink_alcohol_percentage=0, counts_as_water=True)
        coffee = Drink(drink_name='Coffee', drink_water_percentage=98, drink_alcohol_percentage=0, counts_as_water=True)
        beer = Drink(drink_name='Beer', drink_water_percentage=95, drink_alcohol_percentage=5, counts_as_water=False)
        
        db.session.add_all([water, coffee, beer])
        db.session.commit()
        
        # Add logs for each drink
        log1 = DrinkLog(drink_id=water.drink_id, user_id=user.user_id,
                       drink_total_quantity=500, drink_water_quantity=500, drink_alcohol_quantity=0)
        log2 = DrinkLog(drink_id=coffee.drink_id, user_id=user.user_id,
                       drink_total_quantity=250, drink_water_quantity=245, drink_alcohol_quantity=0)
        log3 = DrinkLog(drink_id=beer.drink_id, user_id=user.user_id,
                       drink_total_quantity=330, drink_water_quantity=313, drink_alcohol_quantity=17)
        
        db.session.add_all([log1, log2, log3])
        db.session.commit()
        
        consumption = ControllerDrinkLogs.get_daily_consumption(user.user_id, date.today())
        
        self.assertIsNotNone(consumption)
        self.assertEqual(consumption['total_liquid'], 1080)
        self.assertGreater(consumption['total_water_for_progress'], 0)


if __name__ == '__main__':
    import unittest
    unittest.main()






class TestControllerUser(BaseTestCase):

    def test_create_user(self):
        user = self.create_user()
